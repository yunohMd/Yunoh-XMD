const { cmd } = require("../command");
const axios = require("axios");

// Verified contact
const quotedContact = {
  key: {
    fromMe: false,
    participant: `0@s.whatsapp.net`,
    remoteJid: "status@broadcast"
  },
  message: {
    contactMessage: {
      displayName: "B.M.B VERIFIED âœ…",
      vcard: "BEGIN:VCARD\nVERSION:3.0\nFN:B.M.B VERIFIED âœ…\nORG:BMB-TECH BOT;\nTEL;type=CELL;type=VOICE;waid=254769529791:+254769529791\nEND:VCARD"
    }
  }
};

const contextInfo = {
  forwardingScore: 999,
  isForwarded: true,
  forwardedNewsletterMessageInfo: {
    newsletterJid: "120363382023564830@newsletter",
    newsletterName: "ð™½ð™¾ðš…ð™°-ðš‡ð™¼ð™³",
    serverMessageId: 1
  }
};

// Function to handle image generation
async function generateImage(apiUrl, q, reply, conn, m, title) {
  try {
    if (!q) return reply(`
â•­â”€â”€â”€ã€Œ *MISSING PROMPT* ã€â”€â”€â”€â•®
â”‚ âœï¸ Please provide a prompt!
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    `.trim(), { quoted: quotedContact, contextInfo });

    await reply("â³ *Creating Imagine... Please wait.* ðŸ”¥");

    const response = await axios.get(apiUrl, { responseType: "arraybuffer" });

    if (!response || !response.data) {
      return reply("âŒ API did not return a valid image. Try again later.");
    }

    const imageBuffer = Buffer.from(response.data, "binary");

    await conn.sendMessage(m.chat, {
      image: imageBuffer,
      caption: `ðŸ§  *${title} IMAGE GENERATED BY ð—¡ð—¢ð—©ð—”-ð—«ð— ð——*\n\nâœ¨ *Prompt:* ${q}`,
      contextInfo
    }, { quoted: quotedContact });

  } catch (error) {
    console.error(`${title} Error:`, error);
    reply(`âŒ *Error occurred:* ${error.response?.data?.message || error.message || "Unknown error"}`, { quoted: quotedContact, contextInfo });
  }
}

// FluxAI Command
cmd({
  pattern: "fluxai",
  alias: ["flux", "imagine"],
  react: "ðŸš€",
  desc: "Generate an image using AI (FluxAI).",
  category: "main",
  filename: __filename
}, async (conn, mek, m, { q, reply }) => {
  const apiUrl = `https://api.siputzx.my.id/api/ai/flux?prompt=${encodeURIComponent(q)}`;
  await generateImage(apiUrl, q, reply, conn, m, "FLUX-AI");
});

// Stable Diffusion Command
cmd({
  pattern: "stablediffusion",
  alias: ["sdiffusion", "imagine2"],
  react: "ðŸš€",
  desc: "Generate an image using AI (Stable Diffusion).",
  category: "main",
  filename: __filename
}, async (conn, mek, m, { q, reply }) => {
  const apiUrl = `https://api.siputzx.my.id/api/ai/stable-diffusion?prompt=${encodeURIComponent(q)}`;
  await generateImage(apiUrl, q, reply, conn, m, "STABLE DIFFUSION");
});

// Stability AI Command
cmd({
  pattern: "stabilityai",
  alias: ["stability", "imagine3"],
  react: "ðŸš€",
  desc: "Generate an image using AI (Stability AI).",
  category: "main",
  filename: __filename
}, async (conn, mek, m, { q, reply }) => {
  const apiUrl = `https://api.siputzx.my.id/api/ai/stabilityai?prompt=${encodeURIComponent(q)}`;
  await generateImage(apiUrl, q, reply, conn, m, "STABILITY-AI");
});
